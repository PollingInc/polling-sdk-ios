#!/usr/bin/ruby

puts 'ARGS=' + ARGV.to_s

SCRIPT_INPUT_FILE = ARGV[0]
SCRIPT_OUTPUT_FILE_0 = ARGV[1]

puts 'SCRIPT_INPUT_FILE=' + SCRIPT_INPUT_FILE
puts 'SCRIPT_OUTPUT_FILE_0=' + SCRIPT_OUTPUT_FILE_0

SRCROOT = ENV['SRCROOT'] || './Polling'
DERIVED_FILE_DIR = ENV['DERIVED_FILE_DIR'] || SRCROOT + '/Internal'

puts 'SRCROOT=' + SRCROOT
puts 'DERIVED_FILE_DIR=' + DERIVED_FILE_DIR

USER_SCRIPTS_DIR = SRCROOT + '/Polling/Internal/UserScripts'
CSS_INJECTOR_JS = SRCROOT + '/Polling/Internal/UserScripts/CSSInjector.js'

CSS_INPUT_FILES = Dir[USER_SCRIPTS_DIR + '/*.css']

$css_name_file_pairs = []
CSS_INPUT_FILES.each do |f|
  $css_name_file_pairs << {
    :name => File.basename(f).gsub('.css', ''),
    :file => f
  }
end

puts $css_name_file_pairs

$css_injector = File.read(CSS_INJECTOR_JS)
$css_injector.gsub! "\n", "\\n"
#$css_injector.gsub! "\"", "\\\""

def const_str(f)
  fstr = File.read(f)
  fstr.gsub! /'/, '\\"'
  fstr.gsub! "\n", ""
  $css_injector.sub("/*__CSS__*/", fstr)
end

def decls
  ret = ""
  $css_name_file_pairs.each do |p|
    ret << "FOUNDATION_EXTERN NSString * const POLUserScript" +
           p[:name] + "Source;\n"
  end
  ret
end

def defs
  ret = ""
  $css_name_file_pairs.each do |p|
    ret << "NSString * const POLUserScript" +
           p[:name] + "Source = @\"" + const_str(p[:file]) + "\";\n"
  end
  ret
end

if File.extname(SCRIPT_OUTPUT_FILE_0) == '.h' then
File.write(SCRIPT_OUTPUT_FILE_0,<<-EOF
/*
 *  POLUserScripts.h
 *  Polling
 *
 *  Copyright © 2025 Polling.com. All rights reserved.
 *
 *  DO NOT EDIT THIS FILE
 *
 *  This file is generated automatically from the *.template_h build rule.
 */

#import <Foundation/Foundation.h>

#{decls}

EOF
)
end

if File.extname(SCRIPT_OUTPUT_FILE_0) == '.m' then
File.write(SCRIPT_OUTPUT_FILE_0,<<-EOF
/*
 *  POLUserScripts.m
 *  Polling
 *
 *  Copyright © 2025 Polling.com. All rights reserved.
 *
 *  DO NOT EDIT THIS FILE
 *
 *  This file is generated automatically from the *.template_m build rule.
 */

//#import "POLUserScripts.h"
#import <Foundation/Foundation.h>

#{defs}

EOF
)
end
